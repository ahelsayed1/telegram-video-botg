# ai_smart_chat.py - Ù…Ø­Ø§Ø¯Ø«Ø© Ø°ÙƒÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©
import os
import logging
import random
import json
from datetime import datetime
import urllib.request
import urllib.parse

logger = logging.getLogger(__name__)

class SmartChatManager:
    """Ù…Ø¯ÙŠØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ø°ÙƒÙŠ Ù…ØªÙ‚Ø¯Ù…"""
    
    def __init__(self, db):
        self.db = db
        self.conversation_memory = {}
        self.responses_db = self._load_responses()
        self.user_context = {}
        logger.info("ğŸ§  Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø¬Ø§Ù‡Ø²!")
    
    def _load_responses(self):
        """ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¯ÙˆØ¯"""
        return {
            # Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ù…Ù†Ø¸Ù…Ø©
            "greetings": [
                "ÙˆØ¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡! ğŸŒŸ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø®Ø¯Ù…ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ",
                "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ğŸ¤— Ø³Ø¹ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ Ø¨Ø±Ø¤ÙŠØªÙƒ. Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠÙ‡ØŸ",
                "Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹! ğŸ˜Š Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠØŒ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙƒ.",
                "Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹ ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø£ÙŠ Ø´ÙŠØ¡ ØªØ­ØªØ§Ø¬Ù‡.",
                "Ø£Ù‡Ù„Ø§Ù‹! ğŸŒˆ ÙŠÙˆÙ…Ùƒ Ø¬Ù…ÙŠÙ„ØŸ Ø£Ù†Ø§ Ø³Ø¹ÙŠØ¯ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ."
            ],
            
            "farewell": [
                "Ù…Ø¹ Ø§Ù„Ø³Ù„Ø§Ù…Ø©! ğŸŒŸ Ø£ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ø§Ù‹ Ø±Ø§Ø¦Ø¹Ø§Ù‹.",
                "Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‚Ø§Ø¡! ğŸ¤— Ù„Ø§ ØªØªØ±Ø¯Ø¯ ÙÙŠ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¹Ù†Ø¯ Ø­Ø§Ø¬ØªÙƒ Ù„Ø´ÙŠØ¡.",
                "ÙƒØ§Ù†Øª Ù…Ø­Ø§Ø¯Ø«Ø© Ø±Ø§Ø¦Ø¹Ø©! ğŸ˜Š Ø£Ø±Ø§Ùƒ Ù„Ø§Ø­Ù‚Ø§Ù‹.",
                "ÙˆØ¯Ø§Ø¹Ø§Ù‹! ğŸ‘‹ Ø£ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø§Ù„ØªÙˆÙÙŠÙ‚ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ù…ÙˆØ±Ùƒ.",
                "Ø¥Ù„Ù‰ Ø§Ù„Ù„Ù‚Ø§Ø¡! ğŸŒˆ Ø£Ø±Ø¬Ùˆ Ø£Ù† Ø£ÙƒÙˆÙ† Ù‚Ø¯ Ø³Ø§Ø¹Ø¯ØªÙƒ."
            ],
            
            "thanks": [
                "Ø§Ù„Ø¹ÙÙˆ! ğŸ˜Š Ø³Ø¹ÙŠØ¯ Ù„Ø£Ù†Ù†ÙŠ Ø§Ø³ØªØ·Ø¹Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©. Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø£ÙŠ Ø´ÙŠØ¡ Ø¢Ø®Ø±ØŸ",
                "Ù„Ø§ Ø´ÙƒØ± Ø¹Ù„Ù‰ ÙˆØ§Ø¬Ø¨! ğŸŒŸ Ø£Ù†Ø§ Ù‡Ù†Ø§ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ø®Ø¯Ù…ØªÙƒ.",
                "Ø§Ù„Ø´ÙƒØ± Ù„Ù„Ù‡! ğŸ¤— Ø£Ù†Ø§ Ø³Ø¹ÙŠØ¯ Ù„Ø£Ù†Ù†ÙŠ Ø£ÙØ¯ØªÙƒ.",
                "Ù…Ù† Ø¯ÙˆØ§Ø¹ÙŠ Ø³Ø±ÙˆØ±ÙŠ! ğŸ˜Š Ø£Ù†Øª Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù…Ø±Ø­Ø¨ Ø¨Ùƒ.",
                "Ø§Ù„Ø¹ÙÙˆ! ğŸŒˆ Ø³Ø¹Ø§Ø¯ØªÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ."
            ],
            
            "bot_info": [
                "Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù€ Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø§Ù„Ù…ØªØ·ÙˆØ±! ğŸ¤–\nØªÙ… Ø¨Ø±Ù…Ø¬ØªÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Python ÙˆØ£Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ù…Ù†ØµØ© Railway Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ©.\nÙ…Ù…ÙŠØ²Ø§ØªÙŠ:\nâ€¢ Ù…Ø­Ø§Ø¯Ø«Ø© Ø°ÙƒÙŠØ©\nâ€¢ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\nâ€¢ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙƒØ§Ù…Ù„\nâ€¢ Ø¯Ø¹Ù… Ø¹Ø±Ø¨ÙŠ ÙƒØ§Ù…Ù„",
                "Ø£Ù†Ø§ Ø¨ÙˆØª Ø°ÙƒÙŠ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…! ğŸš€\nØ§Ù„Ø¥ØµØ¯Ø§Ø±: 2.0\nØ§Ù„Ù…Ø·ÙˆØ±: ÙØ±ÙŠÙ‚ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ\nØ§Ù„Ù…Ù†ØµØ©: Railway\nØ§Ù„Ù„ØºØ©: Python\nØ§Ù„Ù…Ù…ÙŠØ²Ø§Øª: Ù…Ø­Ø§Ø¯Ø«Ø© Ø°ÙƒÙŠØ©ØŒ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ÙØµÙ„Ø©",
                "Ø§Ø³Ù…ÙŠ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ! ğŸ¤–\nØ£Ù†Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ù†Ø¸Ø§Ù… Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„.\nØ£Ø³ØªØ·ÙŠØ¹:\nğŸ’¬ Ø¥Ø¬Ø±Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø°ÙƒÙŠØ©\nğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª\nğŸ‘‘ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†\nğŸŒ Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø³Ø­Ø§Ø¨Ø© Railway"
            ],
            
            "jokes": [
                "Ù„Ù…Ø§Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ø®Ø¬ÙˆÙ„Ø§Ù‹ØŸ Ù„Ø£Ù†Ù‡ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„ÙƒÙ†Ù‡ Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ ØªØ°ÙƒØ± Ø£Ø­Ø¯! ğŸ˜„",
                "Ù…Ø§Ø°Ø§ Ù‚Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ù„Ù„Ù…Ù„Ù Ø§Ù„Ø¢Ø®Ø±ØŸ 'Ù„Ù†Ù„ØªÙ‚ÙŠ ÙÙŠ Ø§Ù„Ø¯Ù„ÙŠÙ„!' ğŸ˜‚",
                "Ù„Ù…Ø§Ø°Ø§ Ø°Ù‡Ø¨ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø·Ø¨ÙŠØ¨ØŸ Ù„Ø£Ù†Ù‡ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡ Ø§Ù„ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ø¨Ù‚ (Bugs)! ğŸ›",
                "Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ Ø§Ù„Ù…ÙØ¶Ù„ Ù„Ø¯Ù‰ Ø§Ù„Ø¨Ø­Ø±ØŸ C! ğŸŒŠ",
                "Ù„Ù…Ø§Ø°Ø§ Ù„Ø§ ÙŠÙ„Ø¹Ø¨ Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ÙˆÙ† Ø§Ù„ØºÙ…ÙŠØ¶Ø©ØŸ Ù„Ø£Ù† Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠØ®ØªØ¨Ø¦ÙˆÙ† ÙÙŠ Ø§Ù„Ø£Ø¯Ù„Ø©! ğŸ“"
            ],
            
            "advice": [
                "ğŸ’¡ **Ù†ØµÙŠØ­Ø© Ø°ÙƒÙŠØ©:** Ø®Ø° Ù‚Ø³Ø·Ø§Ù‹ Ù…Ù† Ø§Ù„Ø±Ø§Ø­Ø© ÙƒÙ„ Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„ØŒ Ø³ÙŠØ²ÙŠØ¯ Ù…Ù† Ø¥Ù†ØªØ§Ø¬ÙŠØªÙƒ!",
                "ğŸŒŸ **ØªØ°ÙƒØ±:** Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…Ø³ØªÙ…Ø± Ù‡Ùˆ Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ Ø¹Ø§Ù„Ù… Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§.",
                "ğŸ“š **Ù†ØµÙŠØ­Ø©:** Ø§Ù‚Ø±Ø£ ÙˆÙ„Ùˆ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹ØŒ Ø§Ù„Ø¹Ù„Ù… ÙŠØªØ±Ø§ÙƒÙ… Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª.",
                "ğŸ¤ **Ù†ØµÙŠØ­Ø© Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©:** ÙƒÙ† Ù„Ø·ÙŠÙØ§Ù‹ Ù…Ø¹ Ø§Ù„Ø¬Ù…ÙŠØ¹ØŒ ÙØ£Ù†Øª Ù„Ø§ ØªØ¹Ø±Ù Ù…Ø¹Ø§Ù†Ø§Ø© Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†.",
                "âš¡ **Ù†ØµÙŠØ­Ø© ØªÙ‚Ù†ÙŠØ©:** Ø§Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹."
            ],
            
            "tech_info": [
                "ğŸ“± **Ù…Ø¹Ù„ÙˆÙ…Ø© ØªÙ‚Ù†ÙŠØ©:** Ø£ÙˆÙ„ Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù… ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ ÙÙŠ Ø¹Ø§Ù… 2013!",
                "ğŸ’» **Ù…Ø¹Ù„ÙˆÙ…Ø©:** Ù„ØºØ© Python Ù‡ÙŠ Ø§Ù„Ø£Ø³Ø±Ø¹ Ù†Ù…ÙˆØ§Ù‹ ÙÙŠ Ø¹Ø§Ù„Ù… Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.",
                "ğŸŒ **Ù…Ø¹Ù„ÙˆÙ…Ø©:** Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø³ÙŠÙ†Ù…Ùˆ 13 Ø¶Ø¹ÙØ§Ù‹ ÙÙŠ Ø§Ù„Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ù…Ø³ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©!",
                "ğŸ”§ **Ù…Ø¹Ù„ÙˆÙ…Ø©:** ÙŠÙ…ÙƒÙ† Ù„Ù„Ø¨ÙˆØªØ§Øª Ø¹Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¢Ù„Ø§Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©.",
                "ğŸš€ **Ù…Ø¹Ù„ÙˆÙ…Ø©:** Railway ØªØªÙŠØ­ Ù†Ø´Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ÙÙŠ Ø«ÙˆØ§Ù†Ù Ù…Ø¹Ø¯ÙˆØ¯Ø©!"
            ],
            
            "help": [
                "ğŸ†˜ **ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:**\nâ€¢ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©\nâ€¢ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù†ØµØ§Ø¦Ø­ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡\nâ€¢ Ø¥Ø¹Ø·Ø§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙ‚Ù†ÙŠØ©\nâ€¢ Ø³Ø±Ø¯ Ø§Ù„Ù†ÙƒØª ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ù„ÙŠØ©\nâ€¢ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª\nâ€¢ ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ø­Ø¯ÙŠØ« ÙÙŠ Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹",
                "ğŸ’¬ **Ù…Ø¬Ø§Ù„Ø§Øª Ù…Ø³Ø§Ø¹Ø¯ØªÙŠ:**\n1. Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© ÙˆØªÙ‚Ù†ÙŠØ©\n2. Ù†ØµØ§Ø¦Ø­ ÙˆØ¥Ø±Ø´Ø§Ø¯Ø§Øª\n3. Ù†ÙƒØª ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø³Ù„ÙŠØ©\n4. Ø´Ø±Ø­ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨ÙˆØª\n5. Ù…Ø­Ø§Ø¯Ø«Ø© Ø­Ø±Ø© ÙÙŠ Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹",
                "ğŸ¤ **ÙƒÙŠÙ Ø£Ø³Ø§Ø¹Ø¯ÙƒØŸ**\n- Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡\n- Ø§Ø·Ù„Ø¨ Ù†ØµØ§Ø¦Ø­ Ø£Ùˆ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª\n- Ø§Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„Ø¨ÙˆØª ÙˆÙ…Ù…ÙŠØ²Ø§ØªÙ‡\n- ØªØ­Ø¯Ø« Ù…Ø¹ÙŠ ÙÙŠ Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹\n- Ø§Ø·Ù„Ø¨ Ù†ÙƒØªØ© Ø£Ùˆ Ù‚ØµØ© Ù…Ø³Ù„ÙŠØ©"
            ]
        }
    
    def _analyze_message(self, message: str) -> dict:
        """ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„ÙÙ‡Ù… Ø§Ù„Ù…Ø¹Ù†Ù‰"""
        message_lower = message.lower()
        analysis = {
            'is_greeting': False,
            'is_question': False,
            'is_thanks': False,
            'is_farewell': False,
            'topic': None,
            'keywords': []
        }
        
        # Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„
        greetings = ["Ù…Ø±Ø­Ø¨Ø§", "Ø§Ù‡Ù„Ø§", "Ø§Ù„Ø³Ù„Ø§Ù…", "Ù‡Ù„Ø§", "hello", "hi", "ØµØ¨Ø§Ø­", "Ù…Ø³Ø§Ø¡"]
        farewells = ["Ù…Ø¹ Ø§Ù„Ø³Ù„Ø§Ù…Ø©", "ÙˆØ¯Ø§Ø¹Ø§", "Ø§Ù„Ù‰ Ø§Ù„Ù„Ù‚Ø§Ø¡", "Ø¨Ø§ÙŠ", "goodbye"]
        thanks = ["Ø´ÙƒØ±Ø§", "Ù…Ø´ÙƒÙˆØ±", "ØªØ³Ù„Ù…", "thanks", "thank you"]
        questions = ["ØŸ", "?", "Ù…Ø§", "Ù…Ø§Ø°Ø§", "ÙƒÙŠÙ", "Ù„Ù…Ø§Ø°Ø§", "Ø§ÙŠÙ†", "Ù…ØªÙ‰", "Ù‡Ù„"]
        
        topics = {
            "ØªÙ‚Ù†ÙŠØ©": ["Ø¨ÙˆØª", "Ø¨Ø±Ù…Ø¬Ø©", "ÙƒÙ…Ø¨ÙŠÙˆØªØ±", "Ø§Ù†ØªØ±Ù†Øª", "ØªØ·Ø¨ÙŠÙ‚", "Ø¨Ø±Ù†Ø§Ù…Ø¬", "Ø³ÙˆÙØª ÙˆÙŠØ±", "Ù‡Ø§Ø±Ø¯ ÙˆÙŠØ±"],
            "Ø´Ø®ØµÙŠØ©": ["Ø§Ø³Ù…Ùƒ", "Ù…Ù† Ø§Ù†Øª", "Ø¹Ù…Ø±Ùƒ", "Ø§ÙŠÙ† ØªØ¹ÙŠØ´", "Ù…Ø·ÙˆØ±", "Ù…Ø¨Ø±Ù…Ø¬"],
            "ØªØ±ÙÙŠÙ‡": ["Ù†ÙƒØªØ©", "Ù†ÙƒØª", "ØªØ³Ù„ÙŠØ©", "Ù…Ø±Ø­", "Ø¶Ø­Ùƒ", "ØªØ±ÙÙŠÙ‡", "Ù‚ØµØ©"],
            "Ù…Ø³Ø§Ø¹Ø¯Ø©": ["Ù…Ø³Ø§Ø¹Ø¯Ø©", "Ù…Ø³Ø§Ø¹Ø¯Ù‡", "help", "Ø§Ø³ØªÙØ³Ø§Ø±", "Ø³Ø¤Ø§Ù„", "Ù…Ø¹Ù„ÙˆÙ…Ø©"],
            "Ù†ØµÙŠØ­Ø©": ["Ù†ØµÙŠØ­Ø©", "Ù†ØµÙŠØ­Ù‡", "Ø§Ø±Ø´Ø§Ø¯", "ØªÙˆØ¬ÙŠÙ‡", "Ù†ØµØ§ÙŠØ­", "Ù…Ø´ÙˆØ±Ø©"],
            "Ø¹Ø§Ù…": ["Ù…Ø¹Ù„ÙˆÙ…Ø©", "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª", "Ø­Ø¯Ø«", "Ø§Ø®Ø¨Ø§Ø±", "Ø¬Ø¯ÙŠØ¯"]
        }
        
        # Ø§Ù„ØªØ­Ù„ÙŠÙ„
        analysis['is_greeting'] = any(word in message_lower for word in greetings)
        analysis['is_farewell'] = any(word in message_lower for word in farewells)
        analysis['is_thanks'] = any(word in message_lower for word in thanks)
        analysis['is_question'] = any(word in message_lower for word in questions) or 'ØŸ' in message
        
        # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹
        for topic, keywords in topics.items():
            if any(keyword in message_lower for keyword in keywords):
                analysis['topic'] = topic
                analysis['keywords'] = [k for k in keywords if k in message_lower]
                break
        
        return analysis
    
    async def chat(self, user_id: int, message: str) -> str:
        """Ù…Ø­Ø§Ø¯Ø«Ø© Ø°ÙƒÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø©"""
        try:
            # ØªØ­Ø¯ÙŠØ« Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            self._update_user_context(user_id, message)
            
            # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            analysis = self._analyze_message(message)
            
            # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„
            if analysis['is_greeting']:
                return self._get_response('greetings')
            
            elif analysis['is_farewell']:
                return self._get_response('farewell')
            
            elif analysis['is_thanks']:
                return self._get_response('thanks')
            
            elif analysis['topic'] == "ØªØ±ÙÙŠÙ‡" or "Ù†ÙƒØªØ©" in message.lower():
                return self._get_response('jokes')
            
            elif analysis['topic'] == "Ù…Ø³Ø§Ø¹Ø¯Ø©" or "Ù…Ø³Ø§Ø¹Ø¯Ø©" in message.lower():
                return self._get_response('help')
            
            elif analysis['topic'] == "Ù†ØµÙŠØ­Ø©":
                return self._get_response('advice')
            
            elif analysis['topic'] == "ØªÙ‚Ù†ÙŠØ©" or analysis['topic'] == "Ø¹Ø§Ù…":
                return self._get_response('tech_info')
            
            elif analysis['topic'] == "Ø´Ø®ØµÙŠØ©":
                return self._get_response('bot_info')
            
            elif analysis['is_question']:
                return self._answer_question(message)
            
            else:
                return self._general_conversation(message, user_id)
                
        except Exception as e:
            logger.error(f"âŒ Chat error: {e}")
            return self._get_fallback_response()
    
    def _update_user_context(self, user_id: int, message: str):
        """ØªØ­Ø¯ÙŠØ« Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        if user_id not in self.user_context:
            self.user_context[user_id] = {
                'message_count': 0,
                'last_messages': [],
                'interests': set(),
                'last_active': datetime.now()
            }
        
        self.user_context[user_id]['message_count'] += 1
        self.user_context[user_id]['last_messages'].append(message[:50])
        self.user_context[user_id]['last_active'] = datetime.now()
        
        # Ø­ÙØ¸ Ø¢Ø®Ø± 5 Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø·
        if len(self.user_context[user_id]['last_messages']) > 5:
            self.user_context[user_id]['last_messages'] = self.user_context[user_id]['last_messages'][-5:]
    
    def _get_response(self, category: str) -> str:
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø¯ Ù…Ù† ÙØ¦Ø© Ù…Ø¹ÙŠÙ†Ø©"""
        if category in self.responses_db and self.responses_db[category]:
            return random.choice(self.responses_db[category])
        return self._get_fallback_response()
    
    def _answer_question(self, question: str) -> str:
        """Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø°ÙƒÙŠØ©"""
        question_lower = question.lower()
        
        # Ù‚Ø§Ø¹Ø¯Ø© Ù…Ø¹Ø±ÙÙŠØ© Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
        knowledge_base = {
            "Ù…ØªÙ‰": {
                "keywords": ["Ù…ØªÙ‰", "Ù…ÙˆØ¹Ø¯", "ØªØ§Ø±ÙŠØ®", "Ø²Ù…Ù†"],
                "responses": [
                    "Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¢Ù† Ù‡Ùˆ {time} Ø­Ø³Ø¨ ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø®Ø§Ø¯Ù….",
                    "Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ: {date}",
                    "Ù†Ø­Ù† Ø§Ù„Ø¢Ù† ÙÙŠ Ø¹Ø§Ù… {year}"
                ]
            },
            "ÙƒÙŠÙ": {
                "keywords": ["ÙƒÙŠÙ", "Ø·Ø±ÙŠÙ‚Ø©", "Ø®Ø·ÙˆØ§Øª", "ÙƒÙŠÙÙŠØ©"],
                "responses": [
                    "ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø´Ø±Ø­ Ø°Ù„Ùƒ Ù„Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.",
                    "Ø§Ù„Ø£Ù…Ø± Ø¨Ø³ÙŠØ·! Ø¯Ø¹Ù†ÙŠ Ø£ÙˆØ¶Ø­ Ù„Ùƒ ÙƒÙŠÙÙŠØ© Ø§Ù„Ù‚ÙŠØ§Ù… Ø¨Ø°Ù„Ùƒ.",
                    "Ù‡Ù†Ø§Ùƒ Ø¹Ø¯Ø© Ø·Ø±Ù‚ Ù„Ù„Ù‚ÙŠØ§Ù… Ø¨Ø°Ù„ÙƒØŒ Ø³Ø£Ø®Ø¨Ø±Ùƒ Ø¨Ø£Ø¨Ø³Ø·Ù‡Ø§."
                ]
            },
            "Ù„Ù…Ø§Ø°Ø§": {
                "keywords": ["Ù„Ù…Ø§Ø°Ø§", "Ø³Ø¨Ø¨", "Ø³Ø¨Ø¨", "Ø¹Ù„Ù‰ Ø§ÙŠ Ø§Ø³Ø§Ø³"],
                "responses": [
                    "Ù‡Ù†Ø§Ùƒ Ø£Ø³Ø¨Ø§Ø¨ Ù…ØªØ¹Ø¯Ø¯Ø© Ù„Ø°Ù„ÙƒØŒ Ø£Ù‡Ù…Ù‡Ø§...",
                    "ÙŠØ¹ÙˆØ¯ Ø°Ù„Ùƒ Ø¥Ù„Ù‰ Ø¹Ø¯Ø© Ø¹ÙˆØ§Ù…Ù„ Ù…Ø®ØªÙ„ÙØ©.",
                    "Ù‡Ø°Ø§ Ø³Ø¤Ø§Ù„ Ø¬ÙŠØ¯! Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ùˆ..."
                ]
            },
            "Ù…Ø§ Ù‡Ùˆ": {
                "keywords": ["Ù…Ø§ Ù‡Ùˆ", "Ù…Ø§ Ù‡ÙŠ", "Ù…Ø§ Ù…Ø¹Ù†Ù‰", "ØªØ¹Ø±ÙŠÙ"],
                "responses": [
                    "ÙŠÙ…ÙƒÙ† ØªØ¹Ø±ÙŠÙ Ø°Ù„Ùƒ Ø¨Ø£Ù†Ù‡...",
                    "Ù‡Ùˆ Ø¨Ø¨Ø³Ø§Ø·Ø©...",
                    "ÙŠØ¹Ù†ÙŠ Ø°Ù„Ùƒ..."
                ]
            },
            "Ø§ÙŠÙ†": {
                "keywords": ["Ø§ÙŠÙ†", "Ù…ÙƒØ§Ù†", "Ù…ÙˆÙ‚Ø¹", "Ù…ÙƒØ§Ù†"],
                "responses": [
                    "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø°Ù„Ùƒ ÙÙŠ...",
                    "ÙŠÙ‚Ø¹ Ø°Ù„Ùƒ Ø¹Ø§Ø¯Ø© ÙÙŠ...",
                    "Ù…ÙˆÙ‚Ø¹Ù‡ Ù‡Ùˆ..."
                ]
            }
        }
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„
        for question_type, data in knowledge_base.items():
            if any(keyword in question_lower for keyword in data['keywords']):
                response = random.choice(data['responses'])
                
                # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©
                now = datetime.now()
                if "{time}" in response:
                    response = response.format(time=now.strftime("%H:%M:%S"))
                if "{date}" in response:
                    response = response.format(date=now.strftime("%Y-%m-%d"))
                if "{year}" in response:
                    response = response.format(year=now.year)
                
                return response
        
        # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ø¹Ø±ÙˆÙØ§Ù‹
        return "Ø³Ø¤Ø§Ù„ Ù…Ø«ÙŠØ± Ù„Ù„Ø§Ù‡ØªÙ…Ø§Ù…! ğŸ¤” Ù„Ù„Ø£Ø³Ù Ù„Ø§ Ø£Ù…Ù„Ùƒ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ø¯Ù‚Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§ØŒ Ù„ÙƒÙ†Ù†ÙŠ Ø£ØªØ¹Ù„Ù… Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±!"
    
    def _general_conversation(self, message: str, user_id: int) -> str:
        """Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ø§Ù…Ø© Ø°ÙƒÙŠØ©"""
        message_lower = message.lower()
        
        # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø¹Ø± (Ù…Ø¨Ø³Ø·)
        positive_words = ["Ø³Ø¹ÙŠØ¯", "ÙØ±Ø­", "Ù…Ø¨Ø³ÙˆØ·", "Ø±Ø§Ø¦Ø¹", "Ø¬Ù…ÙŠÙ„", "Ø­Ù„Ùˆ", "Ø­Ø¨", "Ø§Ø­Ø¨", "Ù…Ù…ØªØ§Ø²"]
        negative_words = ["Ø­Ø²ÙŠÙ†", "Ø²Ø¹Ù„Ø§Ù†", "Ù…ØªØ¹ÙƒØ±", "Ø³ÙŠØ¡", "Ù…Ø´ÙƒÙ„Ø©", "ØµØ¹Ø¨", "ØªØ¹Ø¨", "Ù…ØªØ¹Ø¨"]
        
        if any(word in message_lower for word in positive_words):
            responses = [
                "Ø£Ø´Ø¹Ø± Ø¨Ø³Ø¹Ø§Ø¯ØªÙƒ Ù…Ù† Ø®Ù„Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ! ğŸŒŸ Ù‡Ø°Ø§ Ø±Ø§Ø¦Ø¹!",
                "Ø³Ø¹ÙŠØ¯ Ù„Ø£Ù†Ùƒ Ø³Ø¹ÙŠØ¯! ğŸ˜Š Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø§Ù„Ù…Ø²ÙŠØ¯.",
                "Ù‡Ø°Ø§ Ù…Ù…ØªØ§Ø²! ğŸŒˆ Ø¯Ø¹Ù†Ø§ Ù†Ø³ØªÙ…Ø± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©."
            ]
            return random.choice(responses)
        
        elif any(word in message_lower for word in negative_words):
            responses = [
                "Ø£Ø´Ø¹Ø± Ø£Ù†Ùƒ Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø¹Ù…. ğŸ¤— Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ø£Ø³Ù…Ø¹Ùƒ.",
                "Ù„Ø§ ØªÙ‚Ù„Ù‚ØŒ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ù„ØªØ­Ø¯Ø« Ø¹Ù† Ù…Ø§ ÙŠØ²Ø¹Ø¬Ùƒ. ğŸ’­",
                "Ø£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ. ğŸŒŸ Ø£Ø®Ø¨Ø±Ù†ÙŠ Ù…Ø§ Ø§Ù„Ø°ÙŠ ÙŠÙ‚Ù„Ù‚Ùƒ."
            ]
            return random.choice(responses)
        
        # Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¹Ø§Ù…Ø© Ø°ÙƒÙŠØ©
        general_responses = [
            f"Ø£ÙÙ‡Ù… Ù…Ø§ ØªÙ‚ØµØ¯! ğŸ’­ {self._get_random_comment()}",
            f"Ù‡Ø°Ø§ Ù…Ø«ÙŠØ± Ù„Ù„Ø§Ù‡ØªÙ…Ø§Ù…! ğŸŒŸ {self._get_random_comment()}",
            f"Ø±Ø§Ø¦Ø¹! ğŸ¤” {self._get_random_comment()}",
            f"Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù‡Ø°Ø§! ğŸ˜Š {self._get_random_comment()}",
            f"Ù„Ø·ÙŠÙ Ø¬Ø¯Ø§Ù‹! ğŸŒˆ {self._get_random_comment()}"
        ]
        
        return random.choice(general_responses)
    
    def _get_random_comment(self) -> str:
        """ØªØ¹Ù„ÙŠÙ‚ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø°ÙƒÙŠ"""
        comments = [
            "Ø¯Ø¹Ù†ÙŠ Ø£ÙÙƒØ± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ø£ÙƒØ«Ø±.",
            "Ù‡Ø°Ø§ ÙŠÙØªØ­ Ù…Ø¬Ø§Ù„Ø§Ù‹ Ù„Ù„Ù†Ù‚Ø§Ø´.",
            "Ù„Ø¯ÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£ÙÙƒØ§Ø± Ø­ÙˆÙ„ Ø°Ù„Ùƒ.",
            "Ù‡Ø°Ø§ Ù…ÙˆØ¶ÙˆØ¹ ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø©.",
            "Ø¯Ø¹Ù†ÙŠ Ø£ÙˆØ¶Ø­ ÙˆØ¬Ù‡Ø© Ù†Ø¸Ø±ÙŠ.",
            "Ù‡Ø°Ø§ ÙŠÙ‚ÙˆØ¯Ù†ÙŠ Ø¥Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ø¢Ø®Ø±.",
            "Ø£Ø³ØªØ·ÙŠØ¹ Ø±Ø¤ÙŠØ© Ø°Ù„Ùƒ Ù…Ù† Ø²Ø§ÙˆÙŠØ© Ù…Ø®ØªÙ„ÙØ©.",
            "Ù‡Ø°Ø§ ÙŠØ°ÙƒØ±Ù†ÙŠ Ø¨Ø´ÙŠØ¡ Ù…Ù‡Ù….",
            "Ø¯Ø¹Ù†Ø§ Ù†Ø³ØªÙƒØ´Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø£ÙƒØ«Ø±.",
            "Ù‡Ù†Ø§Ùƒ Ø¬Ø§Ù†Ø¨ Ø¢Ø®Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø±."
        ]
        return random.choice(comments)
    
    def _get_fallback_response(self) -> str:
        """Ø±Ø¯ Ø§Ø­ØªÙŠØ§Ø·ÙŠ"""
        fallback_responses = [
            "Ø£ÙÙ‡Ù… Ù…Ø§ ØªÙ‚ØµØ¯! ğŸ’­ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ù„ØªØ­Ø¯Ø« Ø£ÙƒØ«Ø± Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹.",
            "Ù‡Ø°Ø§ Ù…Ø«ÙŠØ± Ù„Ù„Ø§Ù‡ØªÙ…Ø§Ù…! ğŸŒŸ Ø£Ø®Ø¨Ø±Ù†ÙŠ Ø§Ù„Ù…Ø²ÙŠØ¯.",
            "Ø±Ø§Ø¦Ø¹! ğŸ˜Š Ù„Ø¯ÙŠ ÙØ¶ÙˆÙ„ Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯.",
            "Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø°Ù„Ùƒ! ğŸ¤— Ø¯Ø¹Ù†Ø§ Ù†Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø­Ø¯ÙŠØ«.",
            "Ø£Ø­Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª! ğŸŒˆ ØªÙØ¶Ù„ Ø¨Ø§Ù„Ø­Ø¯ÙŠØ«."
        ]
        return random.choice(fallback_responses)
    
    def get_status(self):
        """Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø¯Ù…Ø©"""
        return {
            'chat_available': True,
            'status': 'âœ… Ù†Ø´Ø·',
            'version': '2.0',
            'users_in_memory': len(self.user_context),
            'features': ['Ù…Ø­Ø§Ø¯Ø«Ø© Ø°ÙƒÙŠØ©', 'Ø°Ø§ÙƒØ±Ø© Ù…Ø³ØªØ®Ø¯Ù…', 'ØªØ­Ù„ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„', 'Ø±Ø¯ÙˆØ¯ Ø°ÙƒÙŠØ©']
        }
    
    def get_user_stats(self, user_id: int):
        """Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        if user_id in self.user_context:
            user_data = self.user_context[user_id]
            return {
                'chats_used': user_data['message_count'],
                'daily_limit': 100,
                'chats_remaining': max(0, 100 - user_data['message_count']),
                'status': 'âœ… Ù†Ø´Ø·',
                'last_active': user_data['last_active'].strftime("%H:%M:%S")
            }
        else:
            return {
                'chats_used': 0,
                'daily_limit': 100,
                'chats_remaining': 100,
                'status': 'ğŸ†• Ø¬Ø¯ÙŠØ¯',
                'last_active': 'Ù„Ù… ÙŠØ¨Ø¯Ø£'
              }
