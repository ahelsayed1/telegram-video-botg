import os
import logging
import asyncio
from threading import Thread
from http.server import HTTPServer, BaseHTTPRequestHandler
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from dotenv import load_dotenv

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
load_dotenv()

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ==================== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ====================
from database import db  # âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ù†ÙØµÙ„

# ==================== HTTP Server Ù„Ù„Ù€ Healthcheck ====================
class HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/health' or self.path == '/':
            self.send_response(200)
            self.send_header('Content-type', 'text/plain')
            self.end_headers()
            self.wfile.write(b'OK')
        else:
            self.send_response(404)
            self.end_headers()
    
    def log_message(self, format, *args):
        pass

def run_health_server():
    port = int(os.getenv("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthHandler)
    logger.info(f"ğŸŒ Ø®Ø§Ø¯Ù… Ø§Ù„Ù€ healthcheck ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° {port}")
    server.serve_forever()

# ==================== Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ====================
def get_admin_ids():
    admin_ids_str = os.getenv("ADMIN_IDS", "")
    if admin_ids_str:
        try:
            return [int(admin_id.strip()) for admin_id in admin_ids_str.split(",")]
        except ValueError:
            logger.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ ADMIN_IDS")
            return []
    return []

ADMIN_IDS = get_admin_ids()

def is_admin(user_id: int) -> bool:
    return user_id in ADMIN_IDS

# ==================== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ====================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    
    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.add_or_update_user(
        user_id=user.id,
        username=user.username,
        first_name=user.first_name,
        last_name=user.last_name
    )
    
    await update.message.reply_text(
        f"ğŸš€ Ù…Ø±Ø­Ø¨Ø§Ù‹ {user.first_name}!\n"
        f"Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Railway Ø¨Ù†Ø¬Ø§Ø­!\n\n"
        f"Ù…Ø¹Ø±ÙÙƒ: {user.id}\n"
        f"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = """
ğŸ¯ **Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:**

ğŸ‘¤ **Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:**
/start - Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
/help - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
/status - Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª

ğŸ‘‘ **Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ†:**
/admin - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
/stats - Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
/broadcast - Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
/userslist - Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
"""
    await update.message.reply_text(help_text, parse_mode='Markdown')

async def status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ!")

# ==================== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† ====================
async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    if not is_admin(user_id):
        await update.message.reply_text("â›” Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·!")
        logger.warning(f"Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØµÙˆÙ„ ØºÙŠØ± Ù…ØµØ±Ø­: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id} Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… /admin")
        return
    
    users_count = db.get_users_count()
    
    admin_commands = f"""
ğŸ‘‘ **Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†**

ğŸ“Š /stats - Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
ğŸ“¢ /broadcast - Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹
ğŸ‘¥ /userslist - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ({users_count} Ù…Ø³ØªØ®Ø¯Ù…)

ğŸ”¢ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:**
- Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†: {len(ADMIN_IDS)}
- Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {users_count}
- Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: âœ… Ù†Ø´Ø·Ø©
"""
    
    await update.message.reply_text(admin_commands, parse_mode='Markdown')
    logger.info(f"Ø§Ù„Ù…Ø´Ø±Ù {user_id} ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…")

async def stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    if not is_admin(user_id):
        await update.message.reply_text("â›” Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·!")
        return
    
    stats = db.get_stats()
    users_count = db.get_users_count()
    
    stats_text = f"""
ğŸ“Š **Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©**

ğŸ‘¥ **Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†:**
- Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: {users_count} Ù…Ø³ØªØ®Ø¯Ù…
- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…: {stats.get('new_users_today', 0)}
- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙƒÙ„ÙŠØ©: {stats.get('total_messages', 0)}

ğŸ“¢ **Ø§Ù„Ø¥Ø°Ø§Ø¹Ø§Øª:**
- Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø§Øª: {stats.get('total_broadcasts', 0)}

ğŸ‘‘ **Ø§Ù„Ù…Ø´Ø±ÙÙˆÙ†:**
- Ø§Ù„Ø¹Ø¯Ø¯: {len(ADMIN_IDS)} Ù…Ø´Ø±Ù
- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: {ADMIN_IDS}

ğŸ’¾ **Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:**
- âœ… SQLite Ù†Ø´Ø·Ø©
- ğŸ“ Ø§Ù„Ù…Ù„Ù: {db.db_name}
"""
    
    await update.message.reply_text(stats_text, parse_mode='Markdown')
    logger.info(f"Ø§Ù„Ù…Ø´Ø±Ù {user_id} Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª")

async def broadcast_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    if not is_admin(user_id):
        await update.message.reply_text("â›” Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·!")
        return
    
    if update.message.reply_to_message:
        message = update.message.reply_to_message.text or "Ø±Ø³Ø§Ù„Ø© Ù…ÙŠØ¯ÙŠØ§"
        users_count = db.get_users_count()
        
        await update.message.reply_text(
            f"ğŸ“¢ **Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©:**\n"
            f"'{message[:50]}...'\n\n"
            f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙŠÙ†: {users_count} Ù…Ø³ØªØ®Ø¯Ù…\n"
            f"âœ… Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„\n\n"
            f"â„¹ï¸ *Ù„Ø¥Ø±Ø³Ø§Ù„ ÙØ¹Ù„ÙŠØ§Ù‹:*\n"
            f"Ø£Ø±Ø³Ù„ /sendbroadcast",
            parse_mode='Markdown'
        )
        
        # Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ context
        context.user_data['pending_broadcast'] = message
    else:
        await update.message.reply_text(
            "ğŸ“ **Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… /broadcast:**\n"
            "1. Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø°Ø§Ø¹ØªÙ‡Ø§\n"
            "2. Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ø£Ù…Ø± /broadcast\n\n"
            "âœ… **Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**\n"
            "- Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n"
            "- ØªØªØ¨Ø¹ Ù…Ù† Ø§Ø³ØªÙ„Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø©\n"
            "- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ÙØµÙ„Ø©",
            parse_mode='Markdown'
        )

async def send_broadcast_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    if not is_admin(user_id):
        await update.message.reply_text("â›” Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·!")
        return
    
    if 'pending_broadcast' not in context.user_data:
        await update.message.reply_text("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø© Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ø¥Ø°Ø§Ø¹Ø©!\nØ§Ø³ØªØ®Ø¯Ù… /broadcast Ø£ÙˆÙ„Ø§Ù‹")
        return
    
    message = context.user_data['pending_broadcast']
    users_count = db.get_users_count()
    
    broadcast_id = db.add_broadcast(user_id, message, users_count)
    
    if broadcast_id:
        await update.message.reply_text(
            f"âœ… **ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª**\n\n"
            f"ğŸ“ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: '{message[:100]}...'\n"
            f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙÙŠÙ†: {users_count}\n"
            f"ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©: {broadcast_id}\n\n"
            f"â„¹ï¸ *Ù„Ø§Ø­Ø¸:* Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ ÙŠØ­ØªØ§Ø¬ ØªØ·ÙˆÙŠØ± Ø¥Ø¶Ø§ÙÙŠ.",
            parse_mode='Markdown'
        )
        del context.user_data['pending_broadcast']
    else:
        await update.message.reply_text("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©!")

async def users_list_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    if not is_admin(user_id):
        await update.message.reply_text("â›” Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·!")
        return
    
    users = db.get_all_users()
    users_count = len(users)
    
    if users_count == 0:
        await update.message.reply_text("ğŸ“­ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨Ø¹Ø¯.")
        return
    
    display_users = users[:10]
    
    users_text = f"ğŸ‘¥ **Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†** ({users_count} Ù…Ø³ØªØ®Ø¯Ù…)\n\n"
    
    for i, user in enumerate(display_users, 1):
        users_text += f"{i}. {user['first_name']}"
        if user['username']:
            users_text += f" (@{user['username']})"
        users_text += f" - ID: {user['user_id']}\n"
        join_date = user['join_date'][:10] if user['join_date'] else "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
        users_text += f"   ğŸ“… Ø§Ù†Ø¶Ù…: {join_date}\n"
        users_text += f"   ğŸ’¬ Ø±Ø³Ø§Ø¦Ù„: {user['message_count']}\n\n"
    
    if users_count > 10:
        users_text += f"\nğŸ“‹ Ø¹Ø±Ø¶ 10 Ù…Ù† Ø£ØµÙ„ {users_count} Ù…Ø³ØªØ®Ø¯Ù…\n"
        users_text += "Ø§Ø³ØªØ®Ø¯Ù… /userslist2 Ù„Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©"
    
    await update.message.reply_text(users_text, parse_mode='Markdown')
    logger.info(f"Ø§Ù„Ù…Ø´Ø±Ù {user_id} Ø·Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")

# ==================== Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ====================
def setup_handlers(application):
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("status", status))
    
    application.add_handler(CommandHandler("admin", admin_panel))
    application.add_handler(CommandHandler("stats", stats_command))
    application.add_handler(CommandHandler("broadcast", broadcast_command))
    application.add_handler(CommandHandler("sendbroadcast", send_broadcast_command))
    application.add_handler(CommandHandler("userslist", users_list_command))

def run_bot():
    BOT_TOKEN = os.getenv("BOT_TOKEN")
    
    if not BOT_TOKEN:
        logger.error("âŒ BOT_TOKEN ØºÙŠØ± Ù…Ø¹ÙŠÙ†")
        return
    
    application = Application.builder().token(BOT_TOKEN).build()
    setup_handlers(application)
    
    logger.info(f"ğŸ¤– Ø¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù…...")
    logger.info(f"ğŸ‘‘ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†: {len(ADMIN_IDS)}")
    
    users_count = db.get_users_count()
    logger.info(f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†: {users_count}")
    
    application.run_polling(drop_pending_updates=True)

def main():
    BOT_TOKEN = os.getenv("BOT_TOKEN")
    
    if not BOT_TOKEN:
        logger.error("âŒ ÙŠØ±Ø¬Ù‰ ØªØ¹ÙŠÙŠÙ† BOT_TOKEN ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Railway")
        return
    
    health_thread = Thread(target=run_health_server, daemon=True)
    health_thread.start()
    logger.info("âœ… Ø¨Ø¯Ø£ Ø®Ø§Ø¯Ù… Ø§Ù„Ù€ healthcheck")
    
    run_bot()

if __name__ == "__main__":
    main()
