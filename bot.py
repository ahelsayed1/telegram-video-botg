import os
import logging
import asyncio
from threading import Thread
from http.server import HTTPServer, BaseHTTPRequestHandler
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from dotenv import load_dotenv

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
load_dotenv()

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# ==================== HTTP Server Ù„Ù„Ù€ Healthcheck ====================
class HealthHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/health' or self.path == '/':
            self.send_response(200)
            self.send_header('Content-type', 'text/plain')
            self.end_headers()
            self.wfile.write(b'OK')
        else:
            self.send_response(404)
            self.end_headers()
    
    def log_message(self, format, *args):
        # ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª HTTP
        pass

def run_health_server():
    """ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… HTTP Ø¨Ø³ÙŠØ· Ù„Ù„Ù€ healthcheck"""
    port = int(os.getenv("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthHandler)
    logger.info(f"ğŸŒ Ø®Ø§Ø¯Ù… Ø§Ù„Ù€ healthcheck ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° {port}")
    server.serve_forever()

# ==================== Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù… ====================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ğŸš€ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Railway Ø¨Ù†Ø¬Ø§Ø­!")

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    help_text = """
/start - Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
/help - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
/status - Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
"""
    await update.message.reply_text(help_text)

async def status(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ!")

def run_bot():
    """ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù…"""
    BOT_TOKEN = os.getenv("BOT_TOKEN")
    
    if not BOT_TOKEN:
        logger.error("âŒ BOT_TOKEN ØºÙŠØ± Ù…Ø¹ÙŠÙ†")
        return
    
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Ø¥Ø¶Ø§ÙØ© handlers
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("status", status))
    
    logger.info("ğŸ¤– Ø¨Ø¯Ø£ ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù…...")
    application.run_polling(drop_pending_updates=True)

def main():
    """Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    BOT_TOKEN = os.getenv("BOT_TOKEN")
    
    if not BOT_TOKEN:
        logger.error("âŒ ÙŠØ±Ø¬Ù‰ ØªØ¹ÙŠÙŠÙ† BOT_TOKEN ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Railway")
        return
    
    # Ø¨Ø¯Ø¡ Ø®Ø§Ø¯Ù… HTTP Ù„Ù„Ù€ healthcheck ÙÙŠ thread Ù…Ù†ÙØµÙ„
    health_thread = Thread(target=run_health_server, daemon=True)
    health_thread.start()
    logger.info("âœ… Ø¨Ø¯Ø£ Ø®Ø§Ø¯Ù… Ø§Ù„Ù€ healthcheck")
    
    # Ø¨Ø¯Ø¡ Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    run_bot()

if __name__ == "__main__":
    main()
